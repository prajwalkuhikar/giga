import os
from pathlib import Path
from omegaconf import DictConfig, OmegaConf
import hydra
from src.utils.logging import get_logger

logger = get_logger(__name__)

def run_conversion(cfg_dataset: DictConfig) -> None:
    os.makedirs(cfg_dataset.local_dir, exist_ok=True)
    
    # Check if the dataset exists
    dataset_exists = all(
        (cfg_dataset.local_dir / f"{cfg_dataset.name}_{key}").exists()
        for key in ["rgb", "cad", "base"]
    )
    
    if not dataset_exists:
        logger.error(f"Dataset {cfg_dataset.name} does not exist in {cfg_dataset.local_dir}")
        return
    else:
        logger.info(f"Dataset {cfg_dataset.name} exists. Proceeding with conversion.")

    # formatting the dataset to webdataset format
    imagewise_cmd = "python -m src.scripts.convert_scenewise_to_imagewise --input INPUT --output OUTPUT --nprocs 10"
    webdataset_cmd = "python -m src.scripts.convert_imagewise_to_webdataset --input INPUT --output OUTPUT"

    if cfg_dataset.name in ["tless", "hb"]:
        split = "test_primesense"
    else:
        split = "test"
    split_dir = cfg_dataset.local_dir / split
    tmp_dir = cfg_dataset.tmp / f"{cfg_dataset.name}_image_wise" / split
    os.makedirs(tmp_dir, exist_ok=True)

    imagewise_cmd = imagewise_cmd.replace("INPUT", str(split_dir))
    imagewise_cmd = imagewise_cmd.replace("OUTPUT", str(tmp_dir))

    logger.info(f"Running {imagewise_cmd}")
    os.system(imagewise_cmd)

    webdataset_cmd = webdataset_cmd.replace("INPUT", str(tmp_dir))
    webdataset_cmd = webdataset_cmd.replace("OUTPUT", str(split_dir))

    if cfg_dataset.name in ["tless", "ycbv", "tudl", "itodd"]:
        webdataset_cmd += " --nprocs 4"
    logger.info(f"Running {webdataset_cmd}")
    os.system(webdataset_cmd)

    # Check if key_to_shard.json was created
    key_to_shard_path = split_dir / "key_to_shard.json"
    if key_to_shard_path.exists():
        logger.info(f"key_to_shard.json created successfully at {key_to_shard_path}")
    else:
        logger.error(f"key_to_shard.json not found at {key_to_shard_path}")

@hydra.main(
    version_base=None,
    config_path="../../configs",
    config_name="train",
)
def process(cfg: DictConfig) -> None:
    cfg_data = cfg.data.test
    cfg_data.root_dir = Path(cfg_data.root_dir)
    tmp_dir = cfg_data.root_dir / "tmp"
    os.makedirs(tmp_dir, exist_ok=True)

    OmegaConf.set_struct(cfg, False)
    for dataset_name in [
        "lmo",
        "tless",
        "tudl",
        "icbin",
        "itodd",  # gt not available
        "hb",  # gt not available
        "ycbv",
    ]:
        logger.info(f"Processing {dataset_name}")
        if dataset_name in ["tless", "hb"]:
            prefix = "_primesense"
        else:
            prefix = ""
        
        cfg_dataset = OmegaConf.create(
            {
                "name": dataset_name,
                "local_dir": cfg_data.root_dir / dataset_name,
                "tmp": tmp_dir,
            }
        )
        run_conversion(cfg_dataset)
        logger.info("---" * 100)

if __name__ == "__main__":
    process()
